package samlprovider

import (
	"bytes"
	"crypto/tls"
	"crypto/x509"
	"encoding/base64"
	"encoding/xml"
	securityprotocol "github.com/KvalitetsIT/gosecurityprotocol"
	"github.com/google/uuid"
	"github.com/russellhaering/gosaml2/types"
	dsig "github.com/russellhaering/goxmldsig"
	"go.uber.org/zap"
	"gotest.tools/assert"
	"io/ioutil"
	"net/http"
	"net/url"
	"testing"
	"time"
	//	"fmt"
)

var (
	samlServiceProviderConfig *SamlServiceProviderConfig
	samlHandler               *SamlHandler
	testSamlServiceProvider   *SamlServiceProvider
)

func TestSamlHandler(t *testing.T) {
	setup()
	t.Run("Test IssamlRequest", testIsSamlRequest)
	t.Run("Test GetSessionId", testGetSessionId)
	t.Run("Test HandleSamlResponse invalid time", testHandleSamlLoginResponse_invalidTime)
	t.Run("Test HandleSamlResponse no saml response provided", testHandleSamlLoginResponse_noSamlResponse)
	t.Run("Test SAML metadata without SLO", testMetadata)
	t.Run("Test SAML Response with lots of attributes", testHandleSamlLoginResponse_withLotsOfAttributes)
	t.Run("Test HandleSamlResponse invalid ascii escape chars", testHandleSamlLoginResponse_withAsciiEscapeChars)
}

func setup() {
	keyPair, _ := tls.LoadX509KeyPair("testdata/sp.cer", "testdata/sp.pem")
	// download the metadata from keycloak
	samlServiceProviderConfig = new(SamlServiceProviderConfig)
	samlServiceProviderConfig.IdpMetaDataUrl = "http://keycloak:8080/auth/realms/test/protocol/saml/descriptor"
	samlServiceProviderConfig.ServiceProviderKeystore = &keyPair
	samlServiceProviderConfig.ExternalUrl = "http://localhost:8787"
	samlServiceProviderConfig.EntityId = "test"
	samlServiceProviderConfig.AudienceRestriction = "test"
	samlServiceProviderConfig.SignAuthnRequest = false
	samlServiceProviderConfig.Logger = zap.NewNop().Sugar()
	samlServiceProviderConfig.SamlMetadataPath = "/saml/metadata"
	samlServiceProviderConfig.SamlLogoutPath = "/saml/logout"
	samlServiceProviderConfig.SamlSLOPath = "/saml/SLO"
	samlServiceProviderConfig.SamlSSOPath = "/saml/SSO"
	samlServiceProviderConfig.SessionHeaderName = "MySessionCookie"
	samlServiceProviderConfig.CookieDomain = ""
	samlServiceProviderConfig.CookiePath = "/"
	sessionCache, _ := securityprotocol.NewMongoSessionCache("mongo", "sessions", "session")
	samlServiceProvider, _ := NewSamlServiceProviderFromConfig(samlServiceProviderConfig, sessionCache)

	testSamlServiceProvider = samlServiceProvider
	samlHandler = NewSamlHandler(samlServiceProviderConfig, samlServiceProvider)
}

func testMetadata(t *testing.T) {
	r := &http.Request{}
	r.Method = http.MethodGet
	url, _ := url.Parse("https://test.localhost/saml/metadata.xml")
	r.URL = url
	w := MockResponseWriter{}
	w.buffer = &bytes.Buffer{}
	_, err := samlHandler.handleMetadata(w, r)
	assert.NilError(t, err)
	entityDescriptor := &types.EntityDescriptor{}
	err = xml.Unmarshal(w.buffer.Bytes(), entityDescriptor)
	assert.NilError(t, err)
	assert.Equal(t, entityDescriptor.EntityID, "test")
	assert.Equal(t, len(entityDescriptor.SPSSODescriptor.SingleLogoutServices), 1)
	assert.Equal(t, entityDescriptor.SPSSODescriptor.SingleLogoutServices[0].Location, samlHandler.provider.SamlServiceProvider.ServiceProviderSLOURL)
	assert.Equal(t, len(entityDescriptor.SPSSODescriptor.AssertionConsumerServices), 1)
	assert.Equal(t, entityDescriptor.SPSSODescriptor.AssertionConsumerServices[0].Location, samlHandler.provider.SamlServiceProvider.AssertionConsumerServiceURL)

}

func testGetSessionId(t *testing.T) {
	headerWithCookie := http.Header{}
	sessionId := uuid.New().String()
	headerWithCookie.Add("Cookie", samlHandler.sessionHeaderName+"="+sessionId+";")
	foundInCookie := samlHandler.GetSessionId(&http.Request{Header: headerWithCookie})
	assert.Equal(t, sessionId, foundInCookie)

	header := http.Header{}
	header.Add(samlHandler.sessionHeaderName, sessionId)
	foundInHeader := samlHandler.GetSessionId(&http.Request{Header: header})
	assert.Equal(t, sessionId, foundInHeader)

	headerWithNoSession := http.Header{}
	notFound := samlHandler.GetSessionId(&http.Request{Header: headerWithNoSession})
	assert.Equal(t, "", notFound)

}

func testIsSamlRequest(t *testing.T) {
	assert.Assert(t, samlHandler.isSamlProtocol(&http.Request{URL: &url.URL{Path: samlHandler.metadataPath}}))
	assert.Assert(t, samlHandler.isSamlProtocol(&http.Request{URL: &url.URL{Path: samlHandler.logoutPath}}))
	assert.Assert(t, samlHandler.isSamlProtocol(&http.Request{URL: &url.URL{Path: samlHandler.callbackPath}}))
	assert.Assert(t, samlHandler.isSamlProtocol(&http.Request{URL: &url.URL{Path: samlHandler.sloCallbackPath}}))
	assert.Assert(t, !samlHandler.isSamlProtocol(&http.Request{URL: &url.URL{Path: "/noget" + samlHandler.sloCallbackPath}}))
	assert.Assert(t, !samlHandler.isSamlProtocol(&http.Request{URL: &url.URL{Path: "/saml"}}))
}

func testHandleSamlLoginResponse_invalidTime(t *testing.T) {
	r := &http.Request{}
	w := MockResponseWriter{}
	r.Method = http.MethodGet
	r.Form = url.Values{"SAMLResponse": {"PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIERlc3RpbmF0aW9uPSJodHRwOi8vbG9jYWxob3N0Ojg3ODcvc2FtbC9TU08iIElEPSJJRF80ZjY0MTUxZS0zNDA5LTQ2MmEtYTY5ZS00YTVkMWFjNWM3MTciIEluUmVzcG9uc2VUbz0iX2MyZTM1MGFlLTA4OGEtNDlmMy1iOGFmLWQyZGMxMjZkYmFmZiIgSXNzdWVJbnN0YW50PSIyMDIwLTAzLTA1VDA5OjEzOjMxLjIyOFoiIFZlcnNpb249IjIuMCI+PHNhbWw6SXNzdWVyPmh0dHA6Ly9rZXljbG9hazo4MDgwL2F1dGgvcmVhbG1zL3Rlc3Q8L3NhbWw6SXNzdWVyPjxkc2lnOlNpZ25hdHVyZSB4bWxuczpkc2lnPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHNpZzpTaWduZWRJbmZvPjxkc2lnOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48ZHNpZzpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+PGRzaWc6UmVmZXJlbmNlIFVSST0iI0lEXzRmNjQxNTFlLTM0MDktNDYyYS1hNjllLTRhNWQxYWM1YzcxNyI+PGRzaWc6VHJhbnNmb3Jtcz48ZHNpZzpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkc2lnOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHNpZzpUcmFuc2Zvcm1zPjxkc2lnOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkc2lnOkRpZ2VzdFZhbHVlPmZQR1NaaFp3bFRxNThveXlvQ3RZMWxxbU5hNnU3aHNJRm1GREwzSmVxaTg9PC9kc2lnOkRpZ2VzdFZhbHVlPjwvZHNpZzpSZWZlcmVuY2U+PC9kc2lnOlNpZ25lZEluZm8+PGRzaWc6U2lnbmF0dXJlVmFsdWU+Y1ZrbE1jdURhaURndWdSUldHM3BCeTFFejByOXN0b2ZYVCtCbEpNUzRtNnE1Sm90L1hRaEZxcXlFdXcwSGZnTTJaM3dpNmNJZUhpdHRDMHROUm9iZmltcE51SnRxOVpubVhXS1RKTks3bDdnQ2dzaTRaY215OVpBY3lBdjZpNWNaTHluNmRjaHhrT21XbENEay9KWjdlcVg0K1NNKy9sdVBLdm1vM2VMb3FrTm94NDRZeUlZNnAzVHBka1JieFRLSXZlaHk5NmEvUWtPNXBwMEkyNUMyT1ptZjB5aFVnVGoxUTJUa3Znd1E5SjZOYmliSnNzZXVuMjVkUURuS2tCRWZZTy90MUVkY2dHV0ZaOHpUQjFJTXNvU2hITzJZNCtOcVBCK2RielM3cHlhb04vZXRqSzNjZDYxbnk1V1VxMXdxNm9CblZQc2pTUTFWRTdqRzRTQmlBPT08L2RzaWc6U2lnbmF0dXJlVmFsdWU+PGRzaWc6S2V5SW5mbz48ZHNpZzpLZXlOYW1lPm5ySWVXcFRsRUtXUkQzQzZUd3V2cVR5R29HTGx6X0JhV280MDlPcGhrOTg8L2RzaWc6S2V5TmFtZT48ZHNpZzpYNTA5RGF0YT48ZHNpZzpYNTA5Q2VydGlmaWNhdGU+TUlJQ2x6Q0NBWDhDQmdGd3BNaEdEekFOQmdrcWhraUc5dzBCQVFzRkFEQVBNUTB3Q3dZRFZRUUREQVIwWlhOME1CNFhEVEl3TURNd05EQTVNREExTTFvWERUTXdNRE13TkRBNU1ESXpNMW93RHpFTk1Bc0dBMVVFQXd3RWRHVnpkRENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFOR3pOQ2hzRGxFYklMVE4zUnVwTjdTQ2ZRMWJMbkRxUzk1bWRLMUE1WFBXdHhHUUhlcWxuMHpyRXRjU3ZUSVpHbVhXZW5wWDZqb3FrdzFMaXJpbzBQK29ISzBJVWRBMWVVYS9CSHdRNk5pekR2cCtQUituN3VxcENDWnVwVTVWS0FKbmtyWThrcjZJRlNjTUtGUmNHaGsvZU5HVkdhcDA1U0treXpZRUdGRjRVTVh6eWlFcmpKZXJyRkp3bTNaVnVXNXhsdUNubkJ1cVZDNGxmWFVXVUJ5YUZoaXJiVjR5ZkFDNUNkdStIZXRWcnIwTHRLYXNtc255NUdaNzZISDVhak14RHp2b0dQY1pCTlNYTWhVOEkvczVyVGcyaUhiL1pmWFQ3QytNUk1URjk1SGE4aFF4QnpCOGd3aEptNEh0ME4rRjczTVl2aWVRRyszOHFuSmpwZ2NDQXdFQUFUQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFWMnNkUDFsV3ZJUERBcUFnbjNhRkEwYmpXYStGYjBzczQxekVSVVplQWFwQkpDSkE0YmkveGpoOXVpQ0FERDZSY2VtdHZDZTREekQ1K3o2V3VwWDdBY3VMOGJ6QVBWR3N6SFNhRDNuc0ZFdkpqMUY1S0M0bWdjTXg3SFRETUNiVXNiaXROSXR3bHBZcXl1TFQxZm9mQm5MYzJzSWdJWFY4dHo3UmtJcS9SUXlzSW1nSzc2dzRmaGdvZWNmeG81eDdNVnR2TG1JUS9DYzV6UTNBZG9DZitNdmJvUWNBWXBGNDAyYW1JYlpUZkQ3WlZ5SDBSSzVPS3ZCcDZzSVh6THhPTzBOWlA2bWhPSTdISGFOZ2tmU0NubW50WjduQUp0ZDIzSUlGdUNDWVhjU3BLNHFSUis1cmIxeDhGZ3EwUTRuSXdsOHZPSE9nbVhUaXprQjNNV3hVV1E9PTwvZHNpZzpYNTA5Q2VydGlmaWNhdGU+PC9kc2lnOlg1MDlEYXRhPjxkc2lnOktleVZhbHVlPjxkc2lnOlJTQUtleVZhbHVlPjxkc2lnOk1vZHVsdXM+MGJNMEtHd09VUnNndE0zZEc2azN0SUo5RFZzdWNPcEwzbVowclVEbGM5YTNFWkFkNnFXZlRPc1MxeEs5TWhrYVpkWjZlbGZxT2lxVERVdUt1S2pRLzZnY3JRaFIwRFY1UnI4RWZCRG8yTE1PK240OUg2ZnU2cWtJSm02bFRsVW9BbWVTdGp5U3ZvZ1ZKd3dvVkZ3YUdUOTQwWlVacW5UbElxVExOZ1FZVVhoUXhmUEtJU3VNbDZ1c1VuQ2JkbFc1Ym5HVzRLZWNHNnBVTGlWOWRSWlFISm9XR0t0dFhqSjhBTGtKMjc0ZDYxV3V2UXUwcHF5YXlmTGtabnZvY2ZscU16RVBPK2dZOXhrRTFKY3lGVHdqK3ptdE9EYUlkdjlsOWRQc0w0eEV4TVgza2RyeUZERUhNSHlEQ0VtYmdlM1EzNFh2Y3hpK0o1QWI3ZnlxY21PbUJ3PT08L2RzaWc6TW9kdWx1cz48ZHNpZzpFeHBvbmVudD5BUUFCPC9kc2lnOkV4cG9uZW50PjwvZHNpZzpSU0FLZXlWYWx1ZT48L2RzaWc6S2V5VmFsdWU+PC9kc2lnOktleUluZm8+PC9kc2lnOlNpZ25hdHVyZT48c2FtbHA6U3RhdHVzPjxzYW1scDpTdGF0dXNDb2RlIFZhbHVlPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6c3RhdHVzOlN1Y2Nlc3MiLz48L3NhbWxwOlN0YXR1cz48c2FtbDpBc3NlcnRpb24geG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJJRF9hYWM3MDMxZi0xYWRhLTQ1N2ItYTM0MC0wNDM3M2JmYmY2MjciIElzc3VlSW5zdGFudD0iMjAyMC0wMy0wNVQwOToxMzozMS4yMjhaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3Vlcj5odHRwOi8va2V5Y2xvYWs6ODA4MC9hdXRoL3JlYWxtcy90ZXN0PC9zYW1sOklzc3Vlcj48c2FtbDpTdWJqZWN0PjxzYW1sOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjEuMTpuYW1laWQtZm9ybWF0OnVuc3BlY2lmaWVkIj5ldmE8L3NhbWw6TmFtZUlEPjxzYW1sOlN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uRGF0YSBJblJlc3BvbnNlVG89Il9jMmUzNTBhZS0wODhhLTQ5ZjMtYjhhZi1kMmRjMTI2ZGJhZmYiIE5vdE9uT3JBZnRlcj0iMjAyMC0wMy0wNVQwOToxODoyOS4yMjhaIiBSZWNpcGllbnQ9Imh0dHA6Ly9sb2NhbGhvc3Q6ODc4Ny9zYW1sL1NTTyIvPjwvc2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uPjwvc2FtbDpTdWJqZWN0PjxzYW1sOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDIwLTAzLTA1VDA5OjEzOjI5LjIyOFoiIE5vdE9uT3JBZnRlcj0iMjAyMC0wMy0wNVQwOToxNDoyOS4yMjhaIj48c2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjxzYW1sOkF1ZGllbmNlPnRlc3Q8L3NhbWw6QXVkaWVuY2U+PC9zYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb24+PC9zYW1sOkNvbmRpdGlvbnM+PHNhbWw6QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDIwLTAzLTA1VDA5OjEzOjMxLjIyOFoiIFNlc3Npb25JbmRleD0iYTgzMTdkNTUtNWU3Yi00YmVmLTliYWQtMWI5NTc4ZTQ1NzFkOjo2ODgxOGNhYS1iYzhlLTQ0MDItOWExYi0zNTY1MmQxNDg0YzAiIFNlc3Npb25Ob3RPbk9yQWZ0ZXI9IjIwMjAtMDMtMDVUMTk6MTM6MzEuMjI4WiI+PHNhbWw6QXV0aG5Db250ZXh0PjxzYW1sOkF1dGhuQ29udGV4dENsYXNzUmVmPnVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOnVuc3BlY2lmaWVkPC9zYW1sOkF1dGhuQ29udGV4dENsYXNzUmVmPjwvc2FtbDpBdXRobkNvbnRleHQ+PC9zYW1sOkF1dGhuU3RhdGVtZW50PjxzYW1sOkF0dHJpYnV0ZVN0YXRlbWVudD48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iUm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5tYW5hZ2UtYXV0aG9yaXphdGlvbjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnF1ZXJ5LXJlYWxtczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnZpZXctY2xpZW50czwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnZpZXctaWRlbnRpdHktcHJvdmlkZXJzPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9IlJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+bWFuYWdlLXJlYWxtPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9IlJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+bWFuYWdlLWFjY291bnQ8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iUm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5xdWVyeS11c2Vyczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnVtYV9hdXRob3JpemF0aW9uPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9IlJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+Y3JlYXRlLWNsaWVudDwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnM8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iUm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5tYW5hZ2UtZXZlbnRzPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9IlJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+aW1wZXJzb25hdGlvbjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnZpZXctdXNlcnM8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iUm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5xdWVyeS1ncm91cHM8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iUm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5tYW5hZ2UtdXNlcnM8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iUm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5tYW5hZ2UtY2xpZW50czwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnJlYWxtLWFkbWluPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9IlJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+dmlldy1yZWFsbTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnF1ZXJ5LWNsaWVudHM8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iUm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5vZmZsaW5lX2FjY2Vzczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJSb2xlIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnZpZXctZXZlbnRzPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9IlJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+dmlldy1hdXRob3JpemF0aW9uPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9IlJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+dmlldy1wcm9maWxlPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PC9zYW1sOkF0dHJpYnV0ZVN0YXRlbWVudD48L3NhbWw6QXNzZXJ0aW9uPjwvc2FtbHA6UmVzcG9uc2U+"}}
	response, err := samlHandler.handleSamlLoginResponse(w, r)
	assert.NilError(t, err)
	assert.Equal(t, http.StatusForbidden, response)
}

var (
	saved *securityprotocol.SessionData
)

type MockCache struct {
}

func (mc MockCache) SaveSessionData(sd *securityprotocol.SessionData) error {
	saved = sd
	return nil
}

func (mc MockCache) FindSessionDataForSessionId(sessionId string) (*securityprotocol.SessionData, error) {
	return nil, nil
}

func (mc MockCache) DeleteSessionData(sessionId string) error {
	return nil
}

func testHandleSamlLoginResponse_withAsciiEscapeChars(t *testing.T) {

	// See https://github.com/keycloak/keycloak/issues/14529

	// Given (trust VDX keycloak) and modify the serviceprovider to match the info from VDX
	sessionCache := new(MockCache)

	samlServiceProvider, _ := NewSamlServiceProviderFromConfig(samlServiceProviderConfig, sessionCache)
	samlHandler = NewSamlHandler(samlServiceProviderConfig, samlServiceProvider)

	certData, err := base64.StdEncoding.DecodeString("MIICmzCCAYMCBgF0JJioajANBgkqhkiG9w0BAQsFADARMQ8wDQYDVQQDDAZicm9rZXIwHhcNMjAwODI1MDc0ODM4WhcNMzAwODI1MDc1MDE4WjARMQ8wDQYDVQQDDAZicm9rZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC+93ixkscJCqazFi9zxUZQjQm2JRyohPU41NbXMbo74QJ38VqTCIO5lPfISxASYn+023MYtvgDrmI83gef5k5Q7gfWI4IjSNq566e9FXwWYI3xgz6vty2OJBzXV9L18zQkqHQDHSV2SccdfmPK36HWU9H2IpW68H/6dzgv3X7HcUSEqb+wZ7qtTwc/I7UWYJuu37icCFvs4ay+C1D82Qbwl7+LdbeZ3zwYgFN6BpAwfW6uyzedItDApGXOUe9wFoupurtZOXpnYM3a5GvF44bgD9Os27G468ekvjoo1hgmXMUEjPtiOeihCITjctzVdoVHW8BRZrGlZvEiE9zfa4JDAgMBAAEwDQYJKoZIhvcNAQELBQADggEBALRJFSm8AgJaN53o4kCctDTRT9kPrMJm00ZmhuVq8lar7Qv5sMh4wk1oYWBlsVc1fLTXSgIw3O/XS/Q5ma+jTqL7o7Hx4Q6pzYwO56RNLZ8VrxUvqE1sNzhubIAgRVBwexHT8IwqfcSb72jYHT/I1JXp97dXFo0S982163jAxo3/wEwOQ19Xk6hW/0316XfUK+tvmADO64MFi/a33M46eM+lezoZFbrz70ZX49Aq96D7y12lH/YCSbws5mSRU5UW3CY5wkOnkh1FDUvxVzUgzDR3IP73vj9zbyD3CM1sRIb5pRPp8WFRpQElsxXOnfcOjGh7SQcfBNWhqzI8eT2CmYI=")
	assert.NilError(t, err)
	idpCert, err := x509.ParseCertificate(certData)
	assert.NilError(t, err)
	certStore := dsig.MemoryX509CertificateStore{
		Roots: []*x509.Certificate{},
	}
	certStore.Roots = append(certStore.Roots, idpCert)
	samlServiceProvider.SamlServiceProvider.IDPCertificateStore = &certStore
	samlServiceProvider.SamlServiceProvider.AssertionConsumerServiceURL = "https://vconf-stage.dk/booking/saml/sso"
	samlServiceProvider.SamlServiceProvider.IdentityProviderIssuer = "https://login.vconf-stage.dk/auth/realms/broker"
	samlServiceProvider.SamlServiceProvider.AudienceURI = "medcom:booking"
	const testTimeLayout = "Jan 2, 2006 at 15:04:05.000"
	now, _ := time.Parse(testTimeLayout, "Nov 3, 2022 at 07:13:49.400") //2022-11-03T07:13:49.208
	samlServiceProvider.SamlServiceProvider.Clock = dsig.NewFakeClockAt(now)

	myurl, err := url.Parse("http://pollerolle.dk")
	r := &http.Request{
		URL: myurl,
	}
	assert.NilError(t, err)
	w := MockResponseWriter{}
	r.Method = http.MethodGet
	r.Form = url.Values{"SAMLResponse": {"PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIERlc3RpbmF0aW9uPSJodHRwczovL3Zjb25mLXN0YWdlLmRrL2Jvb2tpbmcvc2FtbC9zc28iIElEPSJJRF8wMGQ0NDAwNy0xYWJlLTQ4Y2ItYmNlMC0xZmU2NTZmMzBhZTMiIEluUmVzcG9uc2VUbz0iXzM2M2Y0MGM5LWE2YjUtNDI2MC1iNTk4LWI0MjAzNTFmYzM5YyIgSXNzdWVJbnN0YW50PSIyMDIyLTExLTAzVDA3OjEzOjQ5LjIwOFoiIFZlcnNpb249IjIuMCI+PHNhbWw6SXNzdWVyPmh0dHBzOi8vbG9naW4udmNvbmYtc3RhZ2UuZGsvYXV0aC9yZWFsbXMvYnJva2VyPC9zYW1sOklzc3Vlcj48ZHNpZzpTaWduYXR1cmUgeG1sbnM6ZHNpZz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PGRzaWc6U2lnbmVkSW5mbz48ZHNpZzpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PGRzaWc6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIvPjxkc2lnOlJlZmVyZW5jZSBVUkk9IiNJRF8wMGQ0NDAwNy0xYWJlLTQ4Y2ItYmNlMC0xZmU2NTZmMzBhZTMiPjxkc2lnOlRyYW5zZm9ybXM+PGRzaWc6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI2VudmVsb3BlZC1zaWduYXR1cmUiLz48ZHNpZzpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzaWc6VHJhbnNmb3Jtcz48ZHNpZzpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiLz48ZHNpZzpEaWdlc3RWYWx1ZT5oSDloZURwRG55Q1lNZW9vZTNtVjlmVU1NdVdSWjg3TUNhKzVmWUkwTE8wPTwvZHNpZzpEaWdlc3RWYWx1ZT48L2RzaWc6UmVmZXJlbmNlPjwvZHNpZzpTaWduZWRJbmZvPjxkc2lnOlNpZ25hdHVyZVZhbHVlPkRqL1U1K2g3UjZ5VkkwYTBxT1prRnRmQ1A1WnI0V3pSVElxdGdXL1JTOUlmZGt4MEh2Zk80aEp1VmFoNXB3ZEx4eWJDRmNHNzJtMmEmIzEzOwp0M2xLR3YxbzJLWU9SZG1IUjlwYTBLZDVXZUE0blJyb0M2UXp6RTkxN0J4akFianZZRFNxS2R3aDZUOTBaTmdzemRHTlFXR1UwTW52JiMxMzsKeEFrbTN6ejdEK1pGUUxoTm1KbG5rTUlpZVRDbDBySmJCY0oySGY0L0k1dER6UHVFQjZZUWd3b09GTHcvaEs0V2dqZGdTM1NVY3lZSSYjMTM7CkxxR3Q3WHI4cExla1RGT3VXd000SnJoWXlsMkxIaXlDdGE1VW5kaHdWUVg4ajVlNHNVK2hYUkFYWEpxZ1cwY3VtMkpOdjF5cXVVWFUmIzEzOwpxdENNZ2pQN3FwZFpBa2FxMnBwZ3FvUGJGSmV6ZER0WU02UnRRQT09PC9kc2lnOlNpZ25hdHVyZVZhbHVlPjxkc2lnOktleUluZm8+PGRzaWc6S2V5TmFtZT5BTV9MS1ZLaVQyc2JhdU5OTWRIREU0UUFITnJUTlF5UzJhLW5rSFBLRy1VPC9kc2lnOktleU5hbWU+PGRzaWc6WDUwOURhdGE+PGRzaWc6WDUwOUNlcnRpZmljYXRlPk1JSUNtekNDQVlNQ0JnRjBKSmlvYWpBTkJna3Foa2lHOXcwQkFRc0ZBREFSTVE4d0RRWURWUVFEREFaaWNtOXJaWEl3SGhjTk1qQXcmIzEzOwpPREkxTURjME9ETTRXaGNOTXpBd09ESTFNRGMxTURFNFdqQVJNUTh3RFFZRFZRUUREQVppY205clpYSXdnZ0VpTUEwR0NTcUdTSWIzJiMxMzsKRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDKzkzaXhrc2NKQ3FhekZpOXp4VVpRalFtMkpSeW9oUFU0MU5iWE1ibzc0UUozOFZxVCYjMTM7CkNJTzVsUGZJU3hBU1luKzAyM01ZdHZnRHJtSTgzZ2VmNWs1UTdnZldJNElqU05xNTY2ZTlGWHdXWUkzeGd6NnZ0eTJPSkJ6WFY5TDEmIzEzOwo4elFrcUhRREhTVjJTY2NkZm1QSzM2SFdVOUgySXBXNjhILzZkemd2M1g3SGNVU0VxYit3WjdxdFR3Yy9JN1VXWUp1dTM3aWNDRnZzJiMxMzsKNGF5K0MxRDgyUWJ3bDcrTGRiZVozendZZ0ZONkJwQXdmVzZ1eXplZEl0REFwR1hPVWU5d0ZvdXB1cnRaT1hwbllNM2E1R3ZGNDRiZyYjMTM7CkQ5T3MyN0c0Njhla3Zqb28xaGdtWE1VRWpQdGlPZWloQ0lUamN0elZkb1ZIVzhCUlpyR2xadkVpRTl6ZmE0SkRBZ01CQUFFd0RRWUomIzEzOwpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFMUkpGU204QWdKYU41M280a0NjdERUUlQ5a1ByTUptMDBabWh1VnE4bGFyN1F2NXNNaDR3azFvJiMxMzsKWVdCbHNWYzFmTFRYU2dJdzNPL1hTL1E1bWEralRxTDdvN0h4NFE2cHpZd081NlJOTFo4VnJ4VXZxRTFzTnpodWJJQWdSVkJ3ZXhIVCYjMTM7CjhJd3FmY1NiNzJqWUhUL0kxSlhwOTdkWEZvMFM5ODIxNjNqQXhvMy93RXdPUTE5WGs2aFcvMDMxNlhmVUsrdHZtQURPNjRNRmkvYTMmIzEzOwozTTQ2ZU0rbGV6b1pGYnJ6NzBaWDQ5QXE5NkQ3eTEybEgvWUNTYndzNW1TUlU1VVczQ1k1d2tPbmtoMUZEVXZ4VnpVZ3pEUjNJUDczJiMxMzsKdmo5emJ5RDNDTTFzUkliNXBSUHA4V0ZScFFFbHN4WE9uZmNPakdoN1NRY2ZCTldocXpJOGVUMkNtWUk9PC9kc2lnOlg1MDlDZXJ0aWZpY2F0ZT48L2RzaWc6WDUwOURhdGE+PGRzaWc6S2V5VmFsdWU+PGRzaWc6UlNBS2V5VmFsdWU+PGRzaWc6TW9kdWx1cz52dmQ0c1pMSENRcW1zeFl2YzhWR1VJMEp0aVVjcUlUMU9OVFcxekc2TytFQ2QvRmFrd2lEdVpUM3lFc1FFbUovdE50ekdMYjRBNjVpJiMxMzsKUE40SG4rWk9VTzRIMWlPQ0kwamF1ZXVudlJWOEZtQ044WU0rcjdjdGppUWMxMWZTOWZNMEpLaDBBeDBsZGtuSEhYNWp5dCtoMWxQUiYjMTM7CjlpS1Z1dkIvK25jNEw5MSt4M0ZFaEttL3NHZTZyVThIUHlPMUZtQ2JydCs0bkFoYjdPR3N2Z3RRL05rRzhKZS9pM1czbWQ4OEdJQlQmIzEzOwplZ2FRTUgxdXJzczNuU0xRd0tSbHpsSHZjQmFMcWJxN1dUbDZaMkROMnVScnhlT0c0QS9Uck51eHVPdkhwTDQ2S05ZWUpsekZCSXo3JiMxMzsKWWpub29RaUU0M0xjMVhhRlIxdkFVV2F4cFdieEloUGMzMnVDUXc9PTwvZHNpZzpNb2R1bHVzPjxkc2lnOkV4cG9uZW50PkFRQUI8L2RzaWc6RXhwb25lbnQ+PC9kc2lnOlJTQUtleVZhbHVlPjwvZHNpZzpLZXlWYWx1ZT48L2RzaWc6S2V5SW5mbz48L2RzaWc6U2lnbmF0dXJlPjxzYW1scDpTdGF0dXM+PHNhbWxwOlN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvc2FtbHA6U3RhdHVzPjxzYW1sOkFzc2VydGlvbiB4bWxucz0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiIgSUQ9IklEXzg2MmY1NjQxLTk2ODktNDRhNS04MmQyLTQ2ZGJhMGYzNGMxYyIgSXNzdWVJbnN0YW50PSIyMDIyLTExLTAzVDA3OjEzOjQ5LjIwOFoiIFZlcnNpb249IjIuMCI+PHNhbWw6SXNzdWVyPmh0dHBzOi8vbG9naW4udmNvbmYtc3RhZ2UuZGsvYXV0aC9yZWFsbXMvYnJva2VyPC9zYW1sOklzc3Vlcj48ZHNpZzpTaWduYXR1cmUgeG1sbnM6ZHNpZz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PGRzaWc6U2lnbmVkSW5mbz48ZHNpZzpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PGRzaWc6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIvPjxkc2lnOlJlZmVyZW5jZSBVUkk9IiNJRF84NjJmNTY0MS05Njg5LTQ0YTUtODJkMi00NmRiYTBmMzRjMWMiPjxkc2lnOlRyYW5zZm9ybXM+PGRzaWc6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI2VudmVsb3BlZC1zaWduYXR1cmUiLz48ZHNpZzpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzaWc6VHJhbnNmb3Jtcz48ZHNpZzpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiLz48ZHNpZzpEaWdlc3RWYWx1ZT53MzdZanR5UWRHTTFnS3o4MmwzYkl3dEZIcUZ3d1pCZUZucmY2WFVYc1IwPTwvZHNpZzpEaWdlc3RWYWx1ZT48L2RzaWc6UmVmZXJlbmNlPjwvZHNpZzpTaWduZWRJbmZvPjxkc2lnOlNpZ25hdHVyZVZhbHVlPkJBSDJQSDlEWTFyOW5XeWk3OWpRUFhYeG1zK1JOUVYwQmZ3emNVMGhjaHlWVW40WHhGdU9xdytMdHRuUTIrOGRId1MrZzRIL2JqOFYmIzEzOwpHcDdkWHFvallPM01jVWhkeFR0bk82eDlURkF6MTYxNThwSnQ0UmhJUTM3ZzE4cXlORHpuTU1qaGZKM0M5dDFIcjJscll1cGNFWUpqJiMxMzsKcVpCNm9aRTZIRUpMRy8rT00vYkVlMVBCTDZtZU1BN1VnazQ2WGxTUnZTZGtuVENBYncrMkgzMnhlbjVrZUtZUjVsZ0NITmFNVFdxbyYjMTM7Ck5GQ3Zid2ZRUTMydi9mUTJBMkt4YmhTc1NNNU9UUGhMTFNnYTFpa2pHcEdXOEtTYUM5TTBVM1o3dkRJVk5PYVJSRDA3aUp6SndlOGEmIzEzOwoydDZvVkxjWDZUV0Q2eE1LeDZ5OUl1RHlwc29lTWZvS3B1SDgvZz09PC9kc2lnOlNpZ25hdHVyZVZhbHVlPjxkc2lnOktleUluZm8+PGRzaWc6S2V5TmFtZT5BTV9MS1ZLaVQyc2JhdU5OTWRIREU0UUFITnJUTlF5UzJhLW5rSFBLRy1VPC9kc2lnOktleU5hbWU+PGRzaWc6WDUwOURhdGE+PGRzaWc6WDUwOUNlcnRpZmljYXRlPk1JSUNtekNDQVlNQ0JnRjBKSmlvYWpBTkJna3Foa2lHOXcwQkFRc0ZBREFSTVE4d0RRWURWUVFEREFaaWNtOXJaWEl3SGhjTk1qQXcmIzEzOwpPREkxTURjME9ETTRXaGNOTXpBd09ESTFNRGMxTURFNFdqQVJNUTh3RFFZRFZRUUREQVppY205clpYSXdnZ0VpTUEwR0NTcUdTSWIzJiMxMzsKRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDKzkzaXhrc2NKQ3FhekZpOXp4VVpRalFtMkpSeW9oUFU0MU5iWE1ibzc0UUozOFZxVCYjMTM7CkNJTzVsUGZJU3hBU1luKzAyM01ZdHZnRHJtSTgzZ2VmNWs1UTdnZldJNElqU05xNTY2ZTlGWHdXWUkzeGd6NnZ0eTJPSkJ6WFY5TDEmIzEzOwo4elFrcUhRREhTVjJTY2NkZm1QSzM2SFdVOUgySXBXNjhILzZkemd2M1g3SGNVU0VxYit3WjdxdFR3Yy9JN1VXWUp1dTM3aWNDRnZzJiMxMzsKNGF5K0MxRDgyUWJ3bDcrTGRiZVozendZZ0ZONkJwQXdmVzZ1eXplZEl0REFwR1hPVWU5d0ZvdXB1cnRaT1hwbllNM2E1R3ZGNDRiZyYjMTM7CkQ5T3MyN0c0Njhla3Zqb28xaGdtWE1VRWpQdGlPZWloQ0lUamN0elZkb1ZIVzhCUlpyR2xadkVpRTl6ZmE0SkRBZ01CQUFFd0RRWUomIzEzOwpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFMUkpGU204QWdKYU41M280a0NjdERUUlQ5a1ByTUptMDBabWh1VnE4bGFyN1F2NXNNaDR3azFvJiMxMzsKWVdCbHNWYzFmTFRYU2dJdzNPL1hTL1E1bWEralRxTDdvN0h4NFE2cHpZd081NlJOTFo4VnJ4VXZxRTFzTnpodWJJQWdSVkJ3ZXhIVCYjMTM7CjhJd3FmY1NiNzJqWUhUL0kxSlhwOTdkWEZvMFM5ODIxNjNqQXhvMy93RXdPUTE5WGs2aFcvMDMxNlhmVUsrdHZtQURPNjRNRmkvYTMmIzEzOwozTTQ2ZU0rbGV6b1pGYnJ6NzBaWDQ5QXE5NkQ3eTEybEgvWUNTYndzNW1TUlU1VVczQ1k1d2tPbmtoMUZEVXZ4VnpVZ3pEUjNJUDczJiMxMzsKdmo5emJ5RDNDTTFzUkliNXBSUHA4V0ZScFFFbHN4WE9uZmNPakdoN1NRY2ZCTldocXpJOGVUMkNtWUk9PC9kc2lnOlg1MDlDZXJ0aWZpY2F0ZT48L2RzaWc6WDUwOURhdGE+PGRzaWc6S2V5VmFsdWU+PGRzaWc6UlNBS2V5VmFsdWU+PGRzaWc6TW9kdWx1cz52dmQ0c1pMSENRcW1zeFl2YzhWR1VJMEp0aVVjcUlUMU9OVFcxekc2TytFQ2QvRmFrd2lEdVpUM3lFc1FFbUovdE50ekdMYjRBNjVpJiMxMzsKUE40SG4rWk9VTzRIMWlPQ0kwamF1ZXVudlJWOEZtQ044WU0rcjdjdGppUWMxMWZTOWZNMEpLaDBBeDBsZGtuSEhYNWp5dCtoMWxQUiYjMTM7CjlpS1Z1dkIvK25jNEw5MSt4M0ZFaEttL3NHZTZyVThIUHlPMUZtQ2JydCs0bkFoYjdPR3N2Z3RRL05rRzhKZS9pM1czbWQ4OEdJQlQmIzEzOwplZ2FRTUgxdXJzczNuU0xRd0tSbHpsSHZjQmFMcWJxN1dUbDZaMkROMnVScnhlT0c0QS9Uck51eHVPdkhwTDQ2S05ZWUpsekZCSXo3JiMxMzsKWWpub29RaUU0M0xjMVhhRlIxdkFVV2F4cFdieEloUGMzMnVDUXc9PTwvZHNpZzpNb2R1bHVzPjxkc2lnOkV4cG9uZW50PkFRQUI8L2RzaWc6RXhwb25lbnQ+PC9kc2lnOlJTQUtleVZhbHVlPjwvZHNpZzpLZXlWYWx1ZT48L2RzaWc6S2V5SW5mbz48L2RzaWc6U2lnbmF0dXJlPjxzYW1sOlN1YmplY3Q+PHNhbWw6TmFtZUlEIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6MS4xOm5hbWVpZC1mb3JtYXQ6dW5zcGVjaWZpZWQiPmctZDFjODYzOTAtODI2ZS00OTg3LWExZjAtYWMwYTU3YjE0OGQ5PC9zYW1sOk5hbWVJRD48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uIE1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI+PHNhbWw6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgSW5SZXNwb25zZVRvPSJfMzYzZjQwYzktYTZiNS00MjYwLWI1OTgtYjQyMDM1MWZjMzljIiBOb3RPbk9yQWZ0ZXI9IjIwMjItMTEtMDNUMDc6MTg6NDcuMjA4WiIgUmVjaXBpZW50PSJodHRwczovL3Zjb25mLXN0YWdlLmRrL2Jvb2tpbmcvc2FtbC9zc28iLz48L3NhbWw6U3ViamVjdENvbmZpcm1hdGlvbj48L3NhbWw6U3ViamVjdD48c2FtbDpDb25kaXRpb25zIE5vdEJlZm9yZT0iMjAyMi0xMS0wM1QwNzoxMzo0Ny4yMDhaIiBOb3RPbk9yQWZ0ZXI9IjIwMjItMTEtMDNUMDc6MTQ6NDcuMjA4WiI+PHNhbWw6QXVkaWVuY2VSZXN0cmljdGlvbj48c2FtbDpBdWRpZW5jZT5tZWRjb206Ym9va2luZzwvc2FtbDpBdWRpZW5jZT48L3NhbWw6QXVkaWVuY2VSZXN0cmljdGlvbj48L3NhbWw6Q29uZGl0aW9ucz48c2FtbDpBdXRoblN0YXRlbWVudCBBdXRobkluc3RhbnQ9IjIwMjItMTEtMDNUMDc6MTM6NDkuMjA4WiIgU2Vzc2lvbkluZGV4PSIxZDBlYTVlNi0zMGNjLTRmNTctOGQ2ZC0xYzljY2QzMWU0MzY6OjIxNzAyNjkwLTQ2ZmQtNGJmZi04YjA3LWM0NWYzOTc4ODBmOCIgU2Vzc2lvbk5vdE9uT3JBZnRlcj0iMjAyMi0xMS0wM1QxNzoxMzo0OS4yMDhaIj48c2FtbDpBdXRobkNvbnRleHQ+PHNhbWw6QXV0aG5Db250ZXh0Q2xhc3NSZWY+dXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6dW5zcGVjaWZpZWQ8L3NhbWw6QXV0aG5Db250ZXh0Q2xhc3NSZWY+PC9zYW1sOkF1dGhuQ29udGV4dD48L3NhbWw6QXV0aG5TdGF0ZW1lbnQ+PHNhbWw6QXR0cmlidXRlU3RhdGVtZW50PjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJkazptZWRjb206bGFzdG5hbWUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+UGVkZXJzZW48L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iZGs6bWVkY29tOnZpZGVvOnJvbGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+bWFuYWdlbWVudC1hZG1pbjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPm1hbmFnZS1hY2NvdW50LWxpbmtzPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+dmlldy1wcm9maWxlPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+bWFuYWdlLWFjY291bnQ8L3NhbWw6QXR0cmlidXRlVmFsdWU+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5tZWV0aW5nLXVzZXI8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iZGs6bWVkY29tOmZpcnN0bmFtZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5Kb25hczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJkazptZWRjb206ZW1haWwiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+anBlQGt2YWxpdGV0c2l0LmRrPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9ImRrOm1lZGNvbTpvcmdhbmlzYXRpb25faWQiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+a2l0PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PC9zYW1sOkF0dHJpYnV0ZVN0YXRlbWVudD48L3NhbWw6QXNzZXJ0aW9uPjwvc2FtbHA6UmVzcG9uc2U+CkNvbGxhcHNl"}}
	response, err := samlHandler.handleSamlLoginResponse(w, r)
	assert.NilError(t, err)
	assert.Equal(t, http.StatusFound, response)
	assert.Equal(t, "PHNhbWw6QXNzZXJ0aW9uIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBJRD0iSURfODYyZjU2NDEtOTY4OS00NGE1LTgyZDItNDZkYmEwZjM0YzFjIiBJc3N1ZUluc3RhbnQ9IjIwMjItMTEtMDNUMDc6MTM6NDkuMjA4WiIgVmVyc2lvbj0iMi4wIj48c2FtbDpJc3N1ZXI+aHR0cHM6Ly9sb2dpbi52Y29uZi1zdGFnZS5kay9hdXRoL3JlYWxtcy9icm9rZXI8L3NhbWw6SXNzdWVyPjxkc2lnOlNpZ25hdHVyZSB4bWxuczpkc2lnPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHNpZzpTaWduZWRJbmZvPjxkc2lnOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48ZHNpZzpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+PGRzaWc6UmVmZXJlbmNlIFVSST0iI0lEXzg2MmY1NjQxLTk2ODktNDRhNS04MmQyLTQ2ZGJhMGYzNGMxYyI+PGRzaWc6VHJhbnNmb3Jtcz48ZHNpZzpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkc2lnOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHNpZzpUcmFuc2Zvcm1zPjxkc2lnOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkc2lnOkRpZ2VzdFZhbHVlPnczN1lqdHlRZEdNMWdLejgybDNiSXd0RkhxRnd3WkJlRm5yZjZYVVhzUjA9PC9kc2lnOkRpZ2VzdFZhbHVlPjwvZHNpZzpSZWZlcmVuY2U+PC9kc2lnOlNpZ25lZEluZm8+PGRzaWc6U2lnbmF0dXJlVmFsdWU+QkFIMlBIOURZMXI5bld5aTc5alFQWFh4bXMrUk5RVjBCZnd6Y1UwaGNoeVZVbjRYeEZ1T3F3K0x0dG5RMis4ZEh3UytnNEgvYmo4VkdwN2RYcW9qWU8zTWNVaGR4VHRuTzZ4OVRGQXoxNjE1OHBKdDRSaElRMzdnMThxeU5Eem5NTWpoZkozQzl0MUhyMmxyWXVwY0VZSmpxWkI2b1pFNkhFSkxHLytPTS9iRWUxUEJMNm1lTUE3VWdrNDZYbFNSdlNka25UQ0FidysySDMyeGVuNWtlS1lSNWxnQ0hOYU1UV3FvTkZDdmJ3ZlFRMzJ2L2ZRMkEyS3hiaFNzU001T1RQaExMU2dhMWlrakdwR1c4S1NhQzlNMFUzWjd2RElWTk9hUlJEMDdpSnpKd2U4YTJ0Nm9WTGNYNlRXRDZ4TUt4Nnk5SXVEeXBzb2VNZm9LcHVIOC9nPT08L2RzaWc6U2lnbmF0dXJlVmFsdWU+PGRzaWc6S2V5SW5mbz48ZHNpZzpLZXlOYW1lPkFNX0xLVktpVDJzYmF1Tk5NZEhERTRRQUhOclROUXlTMmEtbmtIUEtHLVU8L2RzaWc6S2V5TmFtZT48ZHNpZzpYNTA5RGF0YT48ZHNpZzpYNTA5Q2VydGlmaWNhdGU+TUlJQ216Q0NBWU1DQmdGMEpKaW9hakFOQmdrcWhraUc5dzBCQVFzRkFEQVJNUTh3RFFZRFZRUUREQVppY205clpYSXdIaGNOTWpBd09ESTFNRGMwT0RNNFdoY05NekF3T0RJMU1EYzFNREU0V2pBUk1ROHdEUVlEVlFRRERBWmljbTlyWlhJd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUMrOTNpeGtzY0pDcWF6Rmk5enhVWlFqUW0ySlJ5b2hQVTQxTmJYTWJvNzRRSjM4VnFUQ0lPNWxQZklTeEFTWW4rMDIzTVl0dmdEcm1JODNnZWY1azVRN2dmV0k0SWpTTnE1NjZlOUZYd1dZSTN4Z3o2dnR5Mk9KQnpYVjlMMTh6UWtxSFFESFNWMlNjY2RmbVBLMzZIV1U5SDJJcFc2OEgvNmR6Z3YzWDdIY1VTRXFiK3daN3F0VHdjL0k3VVdZSnV1MzdpY0NGdnM0YXkrQzFEODJRYndsNytMZGJlWjN6d1lnRk42QnBBd2ZXNnV5emVkSXREQXBHWE9VZTl3Rm91cHVydFpPWHBuWU0zYTVHdkY0NGJnRDlPczI3RzQ2OGVrdmpvbzFoZ21YTVVFalB0aU9laWhDSVRqY3R6VmRvVkhXOEJSWnJHbFp2RWlFOXpmYTRKREFnTUJBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUxSSkZTbThBZ0phTjUzbzRrQ2N0RFRSVDlrUHJNSm0wMFptaHVWcThsYXI3UXY1c01oNHdrMW9ZV0Jsc1ZjMWZMVFhTZ0l3M08vWFMvUTVtYStqVHFMN283SHg0UTZwell3TzU2Uk5MWjhWcnhVdnFFMXNOemh1YklBZ1JWQndleEhUOEl3cWZjU2I3MmpZSFQvSTFKWHA5N2RYRm8wUzk4MjE2M2pBeG8zL3dFd09RMTlYazZoVy8wMzE2WGZVSyt0dm1BRE82NE1GaS9hMzNNNDZlTStsZXpvWkZicno3MFpYNDlBcTk2RDd5MTJsSC9ZQ1Nid3M1bVNSVTVVVzNDWTV3a09ua2gxRkRVdnhWelVnekRSM0lQNzN2ajl6YnlEM0NNMXNSSWI1cFJQcDhXRlJwUUVsc3hYT25mY09qR2g3U1FjZkJOV2hxekk4ZVQyQ21ZST08L2RzaWc6WDUwOUNlcnRpZmljYXRlPjwvZHNpZzpYNTA5RGF0YT48ZHNpZzpLZXlWYWx1ZT48ZHNpZzpSU0FLZXlWYWx1ZT48ZHNpZzpNb2R1bHVzPnZ2ZDRzWkxIQ1FxbXN4WXZjOFZHVUkwSnRpVWNxSVQxT05UVzF6RzZPK0VDZC9GYWt3aUR1WlQzeUVzUUVtSi90TnR6R0xiNEE2NWlQTjRIbitaT1VPNEgxaU9DSTBqYXVldW52UlY4Rm1DTjhZTStyN2N0amlRYzExZlM5Zk0wSktoMEF4MGxka25ISFg1anl0K2gxbFBSOWlLVnV2Qi8rbmM0TDkxK3gzRkVoS20vc0dlNnJVOEhQeU8xRm1DYnJ0KzRuQWhiN09Hc3ZndFEvTmtHOEplL2kzVzNtZDg4R0lCVGVnYVFNSDF1cnNzM25TTFF3S1JsemxIdmNCYUxxYnE3V1RsNloyRE4ydVJyeGVPRzRBL1RyTnV4dU92SHBMNDZLTllZSmx6RkJJejdZam5vb1FpRTQzTGMxWGFGUjF2QVVXYXhwV2J4SWhQYzMydUNRdz09PC9kc2lnOk1vZHVsdXM+PGRzaWc6RXhwb25lbnQ+QVFBQjwvZHNpZzpFeHBvbmVudD48L2RzaWc6UlNBS2V5VmFsdWU+PC9kc2lnOktleVZhbHVlPjwvZHNpZzpLZXlJbmZvPjwvZHNpZzpTaWduYXR1cmU+PHNhbWw6U3ViamVjdD48c2FtbDpOYW1lSUQgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoxLjE6bmFtZWlkLWZvcm1hdDp1bnNwZWNpZmllZCI+Zy1kMWM4NjM5MC04MjZlLTQ5ODctYTFmMC1hYzBhNTdiMTQ4ZDk8L3NhbWw6TmFtZUlEPjxzYW1sOlN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uRGF0YSBJblJlc3BvbnNlVG89Il8zNjNmNDBjOS1hNmI1LTQyNjAtYjU5OC1iNDIwMzUxZmMzOWMiIE5vdE9uT3JBZnRlcj0iMjAyMi0xMS0wM1QwNzoxODo0Ny4yMDhaIiBSZWNpcGllbnQ9Imh0dHBzOi8vdmNvbmYtc3RhZ2UuZGsvYm9va2luZy9zYW1sL3NzbyIvPjwvc2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uPjwvc2FtbDpTdWJqZWN0PjxzYW1sOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDIyLTExLTAzVDA3OjEzOjQ3LjIwOFoiIE5vdE9uT3JBZnRlcj0iMjAyMi0xMS0wM1QwNzoxNDo0Ny4yMDhaIj48c2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjxzYW1sOkF1ZGllbmNlPm1lZGNvbTpib29raW5nPC9zYW1sOkF1ZGllbmNlPjwvc2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDpDb25kaXRpb25zPjxzYW1sOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAyMi0xMS0wM1QwNzoxMzo0OS4yMDhaIiBTZXNzaW9uSW5kZXg9IjFkMGVhNWU2LTMwY2MtNGY1Ny04ZDZkLTFjOWNjZDMxZTQzNjo6MjE3MDI2OTAtNDZmZC00YmZmLThiMDctYzQ1ZjM5Nzg4MGY4IiBTZXNzaW9uTm90T25PckFmdGVyPSIyMDIyLTExLTAzVDE3OjEzOjQ5LjIwOFoiPjxzYW1sOkF1dGhuQ29udGV4dD48c2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3Nlczp1bnNwZWNpZmllZDwvc2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj48L3NhbWw6QXV0aG5Db250ZXh0Pjwvc2FtbDpBdXRoblN0YXRlbWVudD48c2FtbDpBdHRyaWJ1dGVTdGF0ZW1lbnQ+PHNhbWw6QXR0cmlidXRlIE5hbWU9ImRrOm1lZGNvbTpsYXN0bmFtZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5QZWRlcnNlbjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJkazptZWRjb206dmlkZW86cm9sZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5tYW5hZ2VtZW50LWFkbWluPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+bWFuYWdlLWFjY291bnQtbGlua3M8L3NhbWw6QXR0cmlidXRlVmFsdWU+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj52aWV3LXByb2ZpbGU8L3NhbWw6QXR0cmlidXRlVmFsdWU+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5tYW5hZ2UtYWNjb3VudDwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPm1lZXRpbmctdXNlcjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJkazptZWRjb206Zmlyc3RuYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPkpvbmFzPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9ImRrOm1lZGNvbTplbWFpbCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5qcGVAa3ZhbGl0ZXRzaXQuZGs8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iZGs6bWVkY29tOm9yZ2FuaXNhdGlvbl9pZCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5raXQ8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48L3NhbWw6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDpBc3NlcnRpb24+", saved.Authenticationtoken)
}

func testHandleSamlLoginResponse_withLotsOfAttributes(t *testing.T) {
	// Given
	content, readErr := ioutil.ReadFile("testdata/samlresponse_lotsofattributes.base64")
	assert.NilError(t, readErr)
	expectedAssertion, readErr := ioutil.ReadFile("testdata/samlresponse_lotsofattributes.assertion")
	expectedAssertionStr := string(expectedAssertion)
	assert.NilError(t, readErr)

	cert, err := tls.LoadX509KeyPair("./testdata/sp.cer", "./testdata/sp.pem")
	assert.NilError(t, err)

	// When
	assertionXmlString, err := GetSignedAssertions(string(content), &cert)

	// Then
	assert.NilError(t, err)
	assert.Equal(t, expectedAssertionStr, assertionXmlString)
}

func testHandleSamlLoginResponse_noSamlResponse(t *testing.T) {
	r := &http.Request{}
	w := MockResponseWriter{}
	r.Method = http.MethodGet
	response, err := samlHandler.handleSamlLoginResponse(w, r)
	assert.NilError(t, err)
	assert.Equal(t, http.StatusForbidden, response)
}

//Utils
type MockResponseWriter struct {
	statusCode int
	buffer     *bytes.Buffer
	headers    http.Header
}

func (w MockResponseWriter) Header() http.Header {
	if w.headers == nil {
		w.headers = make(map[string][]string)
	}
	return w.headers
}

func (w MockResponseWriter) Write(b []byte) (int, error) {
	if w.buffer != nil {
		return w.buffer.Write(b)
	}
	return 0, nil
}

func (w MockResponseWriter) WriteHeader(statusCode int) {
	w.statusCode = statusCode
}
